import React, { useState, useEffect } from 'react';
import './registerClient.scss';

const RegisterClient = () => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [businessCard, setBusinessCard] = useState(null);
  const [actions, setActions] = useState([]);
  const [currentActionIndex, setCurrentActionIndex] = useState(0);
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    company: '',
    notes: ''
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  const [submitError, setSubmitError] = useState(null);

  // R√©cup√©rer l'ID de la carte depuis l'URL
  const getCardIdFromUrl = () => {
    const pathParts = window.location.pathname.split('/');
    return pathParts[pathParts.length - 1];
  };

  // Charger les donn√©es de la carte de visite
  useEffect(() => {
    const loadBusinessCard = async () => {
      try {
        setLoading(true);
        setError(null);
        
        const cardId = getCardIdFromUrl();
        console.log('üîç Chargement de la carte:', cardId);
        
        if (!cardId || cardId === 'register-client') {
          throw new Error('ID de carte invalide');
        }

        // Ajouter un timestamp pour √©viter le cache
        const timestamp = new Date().getTime();
        const response = await fetch(`${import.meta.env.VITE_API_URL}/api/business-cards/${cardId}?t=${timestamp}`, {
          method: 'GET',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
        
        if (!response.ok) {
          throw new Error(`Erreur ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìã Donn√©es re√ßues:', data);
        
        setBusinessCard(data);
        
        // Traiter les actions avec cache-busting
        if (data.actions && Array.isArray(data.actions)) {
          const activeActions = data.actions
            .filter(action => action.active !== false)
            .sort((a, b) => (a.order || 0) - (b.order || 0));
          
          console.log('üéØ Actions actives trouv√©es:', activeActions);
          setActions(activeActions);
        } else {
          console.log('‚ùå Aucune action trouv√©e');
          setActions([]);
        }
        
      } catch (err) {
        console.error('‚ùå Erreur lors du chargement:', err);
        setError(err.message);
        setActions([]); // Assurer qu'on a un tableau vide en cas d'erreur
      } finally {
        setLoading(false);
      }
    };

    loadBusinessCard();
  }, []);

  // G√©rer les changements de formulaire
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  // Soumettre le formulaire
  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (isSubmitting) return;
    
    try {
      setIsSubmitting(true);
      setSubmitError(null);
      
      const cardId = getCardIdFromUrl();
      
      const response = await fetch(`${import.meta.env.VITE_API_URL}/api/clients`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          ...formData,
          source: 'business_card',
          businessCardId: cardId
        }),
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Erreur lors de l\'inscription');
      }
      
      console.log('‚úÖ Inscription r√©ussie');
      setSubmitSuccess(true);
      
      // Ex√©cuter les actions suivantes apr√®s inscription
      executeNextActions();
      
    } catch (err) {
      console.error('‚ùå Erreur inscription:', err);
      setSubmitError(err.message);
    } finally {
      setIsSubmitting(false);
    }
  };

  // Ex√©cuter les actions suivantes
  const executeNextActions = () => {
    const remainingActions = actions.slice(currentActionIndex + 1);
    
    remainingActions.forEach((action, index) => {
      setTimeout(() => {
        executeAction(action);
      }, index * 1000);
    });
  };

  // Ex√©cuter une action
  const executeAction = (action) => {
    console.log('üé¨ Ex√©cution de l\'action:', action);
    
    switch (action.type) {
      case 'redirect':
        if (action.url) {
          console.log('üîó Redirection vers:', action.url);
          window.location.href = action.url;
        }
        break;
        
      case 'download':
        if (action.fileUrl) {
          console.log('üì• T√©l√©chargement:', action.fileUrl);
          const link = document.createElement('a');
          link.href = action.fileUrl;
          link.download = action.fileName || 'document';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
        break;
        
      default:
        console.log('‚ùì Type d\'action non reconnu:', action.type);
    }
  };

  // T√©l√©chargement manuel
  const handleManualDownload = () => {
    const downloadAction = actions.find(action => action.type === 'download');
    if (downloadAction) {
      executeAction(downloadAction);
    }
  };

  // D√©terminer ce qu'il faut afficher
  const shouldShowForm = () => {
    // Toujours afficher le formulaire s'il y a une action 'form' OU si pas d'actions
    return actions.length === 0 || actions.some(action => action.type === 'form');
  };

  const shouldShowDownloadOnly = () => {
    // Afficher t√©l√©chargement seulement s'il n'y a QUE des actions de t√©l√©chargement
    return actions.length > 0 && 
           actions.every(action => action.type === 'download') && 
           !actions.some(action => action.type === 'form');
  };

  console.log('üîç √âtat actuel:', {
    loading,
    error,
    actionsCount: actions.length,
    actions: actions.map(a => ({ type: a.type, active: a.active })),
    shouldShowForm: shouldShowForm(),
    shouldShowDownloadOnly: shouldShowDownloadOnly(),
    submitSuccess
  });

  // Affichage du loading
  if (loading) {
    return (
      <div className="register-client-container">
        <div className="loading-container">
          <div className="loading-message">
            <h2>‚è≥ Chargement...</h2>
            <p>R√©cup√©ration des informations de la carte de visite...</p>
          </div>
        </div>
      </div>
    );
  }

  // Affichage d'erreur
  if (error) {
    return (
      <div className="register-client-container">
        <div className="no-actions-container">
          <div className="no-actions-message">
            <h2>‚ùå Erreur</h2>
            <p>Impossible de charger la carte de visite : {error}</p>
            <p>Vous pouvez tout de m√™me vous inscrire :</p>
          </div>
          
          <form onSubmit={handleSubmit} className="register-form">
            <div className="form-section">
              <h3>üìù Vos informations</h3>
              <input
                type="text"
                name="name"
                placeholder="Nom complet *"
                value={formData.name}
                onChange={handleInputChange}
                required
              />
              <input
                type="email"
                name="email"
                placeholder="Email *"
                value={formData.email}
                onChange={handleInputChange}
                required
              />
              <input
                type="tel"
                name="phone"
                placeholder="T√©l√©phone"
                value={formData.phone}
                onChange={handleInputChange}
              />
              <input
                type="text"
                name="company"
                placeholder="Entreprise"
                value={formData.company}
                onChange={handleInputChange}
              />
              <textarea
                name="notes"
                placeholder="Message ou demande particuli√®re"
                value={formData.notes}
                onChange={handleInputChange}
                rows="3"
              />
            </div>
            
            <button 
              type="submit" 
              className="submit-btn"
              disabled={isSubmitting}
            >
              {isSubmitting ? '‚è≥ Inscription...' : '‚úÖ S\'inscrire'}
            </button>
          </form>
        </div>
      </div>
    );
  }

  // Affichage apr√®s inscription r√©ussie
  if (submitSuccess) {
    return (
      <div className="register-client-container">
        <div className="actions-completed">
          <div className="completion-message">
            <h2>‚úÖ Inscription r√©ussie !</h2>
            <p>Merci pour votre inscription. Nous vous contacterons bient√¥t.</p>
          </div>
        </div>
      </div>
    );
  }

  // Affichage t√©l√©chargement uniquement
  if (shouldShowDownloadOnly()) {
    const downloadAction = actions.find(action => action.type === 'download');
    
    return (
      <div className="register-client-container">
        <div className="download-only-container">
          <div className="download-message">
            <h2>üì• T√©l√©chargement disponible</h2>
            <p>Un document est disponible au t√©l√©chargement.</p>
          </div>
          
          <div className="manual-download-section">
            <button 
              onClick={handleManualDownload}
              className="manual-download-btn"
              disabled={!downloadAction?.fileUrl}
            >
              üì• T√©l√©charger {downloadAction?.fileName || 'le document'}
            </button>
            <p className="download-help">
              Cliquez sur le bouton pour t√©l√©charger le document.
            </p>
          </div>
        </div>
      </div>
    );
  }

  // Affichage du formulaire (cas par d√©faut)
  return (
    <div className="register-client-container">
      <form onSubmit={handleSubmit} className="register-form">
        <h2>üìù Inscription</h2>
        <p className="form-subtitle">
          {businessCard?.companyName ? 
            `Contactez ${businessCard.companyName}` : 
            'Laissez-nous vos coordonn√©es'
          }
        </p>
        
        {submitError && (
          <div className="error-message">
            ‚ùå {submitError}
          </div>
        )}
        
        {actions.length > 0 && (
          <div className="actions-list">
            <h3>üìã Actions configur√©es</h3>
            <ul>
              {actions.map((action, index) => (
                <li key={index}>
                  {action.type === 'form' && 'üìù Formulaire d\'inscription'}
                  {action.type === 'download' && `üì• T√©l√©chargement: ${action.fileName || 'Document'}`}
                  {action.type === 'redirect' && `üîó Redirection: ${action.url || 'URL'}`}
                </li>
              ))}
            </ul>
          </div>
        )}
        
        <div className="form-section">
          <h3>üìù Vos informations</h3>
          <div className="form-row">
            <input
              type="text"
              name="name"
              placeholder="Nom complet *"
              value={formData.name}
              onChange={handleInputChange}
              required
            />
            <input
              type="email"
              name="email"
              placeholder="Email *"
              value={formData.email}
              onChange={handleInputChange}
              required
            />
          </div>
          <div className="form-row">
            <input
              type="tel"
              name="phone"
              placeholder="T√©l√©phone"
              value={formData.phone}
              onChange={handleInputChange}
            />
            <input
              type="text"
              name="company"
              placeholder="Entreprise"
              value={formData.company}
              onChange={handleInputChange}
            />
          </div>
          <textarea
            name="notes"
            placeholder="Message ou demande particuli√®re"
            value={formData.notes}
            onChange={handleInputChange}
            rows="4"
          />
        </div>
        
        <button 
          type="submit" 
          className="submit-btn"
          disabled={isSubmitting}
        >
          {isSubmitting ? '‚è≥ Inscription en cours...' : '‚úÖ S\'inscrire'}
        </button>
        
        <p className="form-footer">
          Vos donn√©es sont s√©curis√©es et ne seront pas partag√©es.
        </p>
      </form>
    </div>
  );
};

export default RegisterClient;